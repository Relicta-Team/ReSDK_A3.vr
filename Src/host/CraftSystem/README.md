# Работа с крафтами

Для создания собственных рецептов крафта и редактирования существующих рекомендуется установить расширение для VS Code, которое поможет при создании рецептов.
![img](./install_extension.png?raw=true)

При запуске VSCode в нижней правой части экрана нам будет предложено установить расширение YAML. Так же его можно установить через раздел расширений в левом меню (значок с квадратиками).

После установки вы сможете вызывать автодополнение в рецептах крафта (комбинация **Ctrl + Пробел**), просматривать информацию о разных разделах в рецепте а так же устранять ошибки и неверно заполненные данные.

![img](https://media.discordapp.net/attachments/1111195376641384470/1297229455030353950/image.png?ex=671724d3&is=6715d353&hm=6876554e6e0cc2416cd26587bebb0d7712125bd811a4a98b1e63f4ac8e5d1528&=&format=webp&quality=lossless)

#  Спецификация файла конфигурации

Для начала быстро пробежимся по спецификации разметки для описания конфигов крафтов. Используется стандартный yaml 1.2. Yaml похож на json за исключением необходимости в фигурных скобках. Разделение на объекты осуществляется с помощью отступов.
Пример взят и адаптирован [отсюда](https://gist.github.com/xputerax/70a32929bf2603ed65990cc3550902a8)

```yaml
# Это комментарий!

# Объект
person:
  # Строчные значения. Могут быть с двойными, одиночными кавычками. Или без кавычек вовсе.
  name: &name "Вася" # имя якоря (&name) не обязательно должно совпадать с именем ключа
  description: Простой мужик
  occupation: 'Рабочий'
  
  # числовые значения
  age: 38
  height: 1.74 

  # exponential form
  fav_num: 1e+10

  # булево.
  male: true

  # null-значение
  flaws: null

  # список значений
  hobbies: 
    - Кушать
    - Спать
    - Рабоать
    - Отдыхать на диване

  # иной способ создать список
  movies: ['Темный рыцарь', "Обитаемый остров"]

  # список объектов
  friends:
  - name: "Колян" # первый объект
    age: 42
  - {name: 'Петька', age: 22} # второй объект (объявление в одну строку)
  -
    name: "Жорик"
    age: 33

  # длинный текст. перенос строки будет удален
  description: >
    Labore officia laborum Lorem culpa excepteur anim et. 
    Eiusmod non quis qui tempor ea proident consectetur eiusmod 
    ipsum. Enim consequat proident nisi nostrud ea occaecat 
    fugiat tempor in aliquip irure do minim. Sit esse non 
    laborum et. Minim sit non Lorem esse et quis labore 
    reprehenderit veniam minim. Consequat consequat amet enim 
    magna ea veniam fugiat nulla anim reprehenderit qui irure. 
    Qui aliqua irure sit cupidatat aute commodo cillum id.
  # с сохранением форматирования.
  signature: |
    Aiman
    PHHM Organization
    email - hejes@gmail.com

  # ссылка. Значение будет ссылаться к якорю &ANCHOR
  id: *name # "Вася"

  # привязка объекта типа ключ-значение
  base: &base
    var1: 'value1'

  foo:
    <<: *base # подставляет var1: 'value'.
    var2: 'value2'

```

# Система крафтов

Крафты описываются в файлах конфигурации и автоматически загружаются при запуске сервера.
Есть несколько типов конфигураций крафтов:
- Интерактивные - когда происходит нажатие предметом по другому предмету.
- Выборочные - открываются через меню.

Выборочные в свою очередь делятся на:
- Обычные - работают как и на старой системе. Удаляются компоненты и появляются результирующие объекты.
- Строительные - при попытке создания у клиента создается объект установки, который можно крутить и вращать.
- Системные - например мясодавка.

Внутри рецептов типы конфигураций обозначаются следующим образом:

- **default** - обычный сборочный крафт с помощью меню крафтов. Прим.: сложите в одном месте 10 камней и через меню выберите "Создать каменную стену"
- **building** - строительный крафт. Отличается от default только возможностью предпросмотра и изменения расстановки объекта.
- **system** - завязанные на системах крафты. Сковородка, печь, металлургия и т.д.
- **interact** - интерактивный крафт. Срабатывает когда нажимаем ЛКМ чем-то по чему-то и получается новый предмет. Например, нарезка грибов, отделение мяса от костей и прочие крафты, где происходит интеракция **только между двумя** предметами.

# Описание работы системы
Условно процесс создания из крафта делится на 3 основных этапа:
1. Выбор крафта. Это делает пользователь через меню, либо система сама находит (в случае для интерактивных крафтов).
2. Система запрашивает все объекты в точке создания\интеракции вокруг создающего. Происходит сопоставление и сравнение объектов со списком, указанным в требуемых ингредиентах. Удовлетворяющие всем условиям объекты добавляются в подготовленные предметы. Если объект не соответствует одному из условий - он отбрасывается из подготовленных. Сохраняются контексты модификаторов и провала.
3. Подготовленные предметы удаляются, портятся или меняют свои состояния, описанные в конфигурации рецепта. После создается предмет(ы) с указанными модификаторами создания.

## Общие настройки конфига
Общие настройки описывают название, тип и принадлежность рецепта.

```yml
  # Название рецепта. Отображается в меню
- name: Рецепт плова # По умолчанию берётся название из класса первого ингридиента.
  
  # Для рецептов с особыми условиями создания лучше описать их тонкости. 
  desc: Заложите фасолей в кастрюлю и варите до готовки # по умолчанию не определено

  # Тип рецепта. Может быть default, system, building, interact
  type: default # по умолчанию default

  # Отвечает за вкладку меню, в которой хранится рецепт.
  category: Other # По умолчанию Other

  # Спецификация системного рецепта. Используется только если type: system
  system_specific: frying_pan

  # игнорирование рецепта системой. используется для выключенных рецептов, либо для создания ссылочных наборов (используя & и *)
  ignored: false
```


## Ключевые настройки
Во всех крафтах есть разделы настроек:
- **required** - Требования для успешного крафта
- **failed_handler** - обработка провала крафта
- **result** - результат: предметы, количество и модификаторы
- **options** - дополнительные опции крафта

### required
Раздел required содержит список необходимых ингредиентов для крафта и требуемые навыки.

```yml
required:

  # Видимость рецепта в меню даже при нехватке навыков. 
  # режим ограничения доступности рецепта
  # off - можно скрафтить даже с недостаточным навыком
  force_visible: false # По умолчанию выключено - рецепт не будет виден если скиллов не хватает

  #секция для ограничения по навыкам для видимости рецепта. требуется хотя бы одно соотвествие навыку для одобрения
  # так же отвечает за то будет ли бросок на успех
  skills: 
    cavelore: 2 # требуется знание пещер не меньше 2х
    cooking: 4
  
  #секция компонентов (ингредиентов крафта)
  components:
    # класснейм предмета\структуры.
    # Может быть строкой, массивом строк или мета-строкой, например:
    # WoodenDebris(1-3) во время компиляции заменится на массив 
    # [WoodenDebris1,WoodenDebris2,WoodenDebris3]
    - class: Item 
      
      # кастомное название выводимое в рецепте
      name: Предмет

      # Количество необходимых предметов. Не может быть меньше 1...
      count: 1 # по умолчанию 1.
      
      # Сколько должно быть хп у предмета чтобы он мог считаться ингредиентом. Может быть процентным значением, а может быть числом.
      hp: 100% # по умолчанию без ограничений по хп

      # Отвечает за проверку наследников. Если false - проверяются только типы указанные для класса
      check_type_of: true # по умолчанию включен

      # Является ли ингредиент опциональным (необязательным) для крафта
      optional: false # по умолчанию выключен

      # Будет ли уничтожен ингредиент после успешного крафта
      destroy: true # по умолчанию включен, т.е. ингредиентами могут быть объекты типа свойства class и все его наследники. В примере с Item сюда так же попадают любые предметы, которые можно взять в руки.

      # (для опытных) код условия, которое при удовлетворении позволит использовать ингредиент
      condition: isItem() && weight > 0.5 # по умолчанию без ограничений

      # внутренний тег ингредиента. используется в обработчиках и результате. нужен для сопоставления к параметрам
      meta_tag: ITEM_1
```

### failed_handler
В этом разделе включается обработчик провала крафта. Если он определён, то будет выполняться проверка по навыкам на возможность крафта. По умолчанию null.
```yml
failed_handler:
  handler_type: destroy_ingredients # название обработчика при провале.
  # опциональные параметры
  item: Debris
  count: 1 # может быть диапазоном -> count: {min: 1, max: 4}
```

### result
В этом разделе описывается что получается на выходе. Может быть объектом, а может быть списком объектов (если должно крафтиться несколько разных объектов).

```yml
result: # может содержать несколько выходных объектов
  class: Item # класс создаваемого объекта
  count: 1 # количество создаваемых предметов
  
  # модификатор радиуса спавна объекта. За центр берется средняя точка (midpoint) между позициями всех ингредиентов.
  # используется для всех типов создания кроме строительного (так как при стройке игрок сам выбирает конкретное место установки)
  radius: 0.2 # по умолчанию 0

  # модификаторы, применяемые к создаваемому предмету
  # ключ value для модификаторов с одним параметром
  #  
  # modifiers:
  #   - name: example_multiparam_mod
  #     named_param: 123
  #     another_value: "hello!"
  # !!! Модификаторы в примере могут не существовать в сборке или существовать с другими названиями !!!
  modifiers:
    - name: set_name # имя модификатора
      value: Созданный предмет из {basename.lower} # про форматированные данные в разделах ниже
    - name: auto_ht # модификатор может не принимать значений
    - auto_weight # также ключ name можно опустить если у модификатора нет параметров
    - name: another_modifier
      modifier_param_bool: false
      modifier_param_string: "hello"
    
```

### options
Секция дополнительных опций крафта.

```yml
options:
  # На каком расстоянии будут проверяться объекты на соответствие ингредиентам.
  collect_distance: 1.5 # По умолчанию 0.8
  
  # Длительность прогресс-бара при создании.
  # Поддерживает математические выражения со статистикой персонажа и диапазонами: rta (RealTimeAction), например при rta 3.5: 
  #     rta * 2 + 1
  # что означает (3.5 * 2 + 1) -> 7 + 1 -> 8, что примерно в 2 раза медленнее чем обычное стандартное действие персонажа
  # Так же поддерживает irnd(1,5); rnd(1,5) - для рандомного выбора из диапазона
  
  # Поддерживает вычисление от текущего навыка с помощью from_skill(min,max). Этот макрос берет нижнее и верхнее значение сопоставляя его с навыком крафтера. 
  # Например: from_skill(40,2) при навыке 12 даст результат 18

  # Например: (rta * 2) + from_skill(15,5) + irnd(1,2)
  craft_duration: (rta * 2) + from_skill(15,5) + irnd(1,2) # По умолчанию rta. можно использовать навыки персонажа (должны быть написаны в англ раскладке)
```

## Интерактивные
Интерактивные крафты имеют дополнительные свойства в секции components. Внутри неё должны присутствовать 2 раздела `hand_item` - для предмета в руке и `target` для цели взаимодействия.
```yml
# пример требования для резки грибов
required:
  skills: {cooking: 1} # как и в любых обычных крафтах
  components:
    # предмет в руках
    hand_item:
      # тип предмета
      class: Knife
      # ограничение наследования. см. check_type_of в обычных требованиях
      check_type_of: true # по умолчанию включен
      # требования для хп предмета в руке
      hp: 70% #может быть как числом так и процентным значением
      # можно развернуть до объекта чтобы выводить сообщение
      #hp:
      #  value: 70%
      #  error_message: "{basename} слишком повреждён."
    
      # уничтожение при крафте (см required в обычных требованиях)
      destroy: false # по умолчанию выключен

    # цель взаимодействия
    target:
      class: Mushroom
      check_type_of: true # по умолчанию включен
      # сколько должно быть хп у цели
      hp:
        value: 3
        message: "{basename} слишком повреждён"
```

Результат так же имеет некоторые незначительные отличия:
```yml
result:
  # стандартное. см. result для обычных крафтов
  class: Mushroom_Chopped
  count: {min: 2, max: 3}
  radius: 0.2
  modifiers: [auto_hp, auto_weight]

  # дополнительное
  
  sound: "act/chop(1-3).ogg" # (опционально) проигрыш звука при действии. (1-3) подставляет рандомное число
  
  # сообщение успешного действия
  emote: # (опционально) вызывает один из эмоутов. слова в круглых скобках являются рандомной заменой
      - "(рубит|кромсает) {target.lower}."
      - "разделяет {target.lower} на мелкие кусочки."
      - "ловко оперирует {hand_item.lower} по {target.lower}"
```

# Минимальный пример
```yml
- name: Стул
  required:
    skills:
      engineering: 4
    components:
      - class: WoodenLog
        count: 2
      - class: Nails
        count: 1
  failed:
    enable: true
    item: WoodenDebris
    count: {min: 1, max: 2}
  result:
    class: WoodenChair
    count: 1
    modifiers: [auto_weight, auto_ht]
```

